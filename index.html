<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Gael & Mar | Studio</title>
    <style>
        :root { --p: #ff477e; --bg: #fdf0f5; }
        * { box-sizing: border-box; touch-action: none; -webkit-user-select: none; }
        body { font-family: system-ui, sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* HEADER */
        .header { background: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; height: 65px; z-index: 10; }
        #timer { font-weight: 800; color: var(--p); font-size: 22px; width: 70px; }
        #word { font-weight: bold; background: #fff; padding: 6px 15px; border-radius: 20px; border: 2px solid var(--p); font-size: 16px; color: #333; flex-grow: 1; text-align: center; margin: 0 10px; }

        /* JUEGO */
        #main-game { display: flex; flex-direction: column; flex-grow: 1; padding: 10px; gap: 10px; }
        .canvas-container { position: relative; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.08); flex: 1; display: flex; flex-direction: column; }
        #my-section { flex: 1.6; border: 3px solid var(--p); } 
        canvas { width: 100%; height: 100%; display: block; background: white; cursor: crosshair; }

        /* CONTROLES PRO */
        .app-controls { position: absolute; bottom: 12px; left: 12px; right: 12px; display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.95); padding: 8px 15px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .tool-group { display: flex; align-items: center; gap: 10px; }
        input[type="range"] { width: 80px; accent-color: var(--p); }
        input[type="color"] { border: none; width: 35px; height: 35px; border-radius: 50%; background: none; cursor: pointer; }

        .label { position: absolute; top: 8px; left: 15px; font-size: 11px; font-weight: 800; color: #bbb; pointer-events: none; letter-spacing: 1px; }
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; transition: 0.5s; }
        .btn-start { padding: 18px 50px; border: none; border-radius: 40px; background: var(--p); color: white; font-weight: bold; font-size: 1.3rem; cursor: pointer; box-shadow: 0 10px 20px rgba(255, 71, 126, 0.3); }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="overlay">
        <h1 style="font-size: 2.5rem; margin-bottom: 10px;">Gael ‚ù§Ô∏è Mar</h1>
        <p style="margin-bottom: 30px; opacity: 0.8;">¬øListos para el desaf√≠o?</p>
        <button class="btn-start" id="startBtn">COMENZAR</button>
    </div>

    <div class="header">
        <div id="timer">01:00</div>
        <div id="word">ESPERANDO...</div>
        <button id="reset" style="background:none; border:none; font-size: 22px; cursor:pointer;">üîÑ</button>
    </div>

    <div id="main-game">
        <div class="canvas-container" id="my-section">
            <div class="label" id="my-label">TU LIENZO</div>
            <canvas id="myCanvas"></canvas>
            
            <div class="app-controls">
                <div class="tool-group">
                    <input type="color" id="color" value="#ff477e">
                    <input type="range" id="size" min="2" max="25" value="6">
                </div>
                <button onclick="clearDraw()" style="border:none; background:none; font-size:24px; cursor:pointer;">üóëÔ∏è</button>
            </div>
        </div>

        <div class="canvas-container">
            <div class="label" id="partner-label">ELLA DIBUJA</div>
            <canvas id="partnerCanvas"></canvas>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, onChildAdded } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "minijuego-eabcb.firebaseapp.com",
            databaseURL: "https://minijuego-eabcb-default-rtdb.firebaseio.com/",
            projectId: "minijuego-eabcb",
            appId: "TU_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let myName = prompt("¬øQui√©n eres? (Gael/Mar)").trim().toLowerCase();
        if (myName !== 'mar') myName = 'gael';
        const partnerName = (myName === 'gael') ? 'mar' : 'gael';
        
        document.getElementById('my-label').innerText = "GAEL (T√ö)";
        document.getElementById('partner-label').innerText = "MAR (ELLA)";
        if(myName === 'mar') {
            document.getElementById('my-label').innerText = "MAR (T√ö)";
            document.getElementById('partner-label').innerText = "GAEL (√âL)";
        }

        const mC = document.getElementById('myCanvas'), pC = document.getElementById('partnerCanvas');
        const mCtx = mC.getContext('2d'), pCtx = pC.getContext('2d');

        function res() {
            mC.width = mC.clientWidth; mC.height = mC.clientHeight;
            pC.width = pC.clientWidth; pC.height = pC.clientHeight;
        }
        window.onresize = res; setTimeout(res, 500);

        // --- DIBUJO ---
        let draw = false, lx = 0, ly = 0;
        const getXY = (e) => {
            const r = mC.getBoundingClientRect();
            const cX = e.touches ? e.touches[0].clientX : e.clientX;
            const cY = e.touches ? e.touches[0].clientY : e.clientY;
            return [cX - r.left, cY - r.top];
        };

        const dLine = (ctx, x1, y1, x2, y2, c, sz) => {
            ctx.strokeStyle = c; ctx.lineWidth = sz; ctx.lineCap = "round"; ctx.lineJoin = "round";
            ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke();
        };

        mC.addEventListener('mousedown', (e) => { draw = true; [lx, ly] = getXY(e); });
        mC.addEventListener('touchstart', (e) => { draw = true; [lx, ly] = getXY(e); }, {passive:false});

        const handleMove = (e) => {
            if (!draw) return;
            if (e.cancelable) e.preventDefault();
            const [x, y] = getXY(e);
            const col = document.getElementById('color').value;
            const sz = document.getElementById('size').value;
            
            dLine(mCtx, lx, ly, x, y, col, sz);
            push(ref(db, `drawings/${myName}`), { x1: lx, y1: ly, x2: x, y2: y, c: col, s: sz, w: mC.width, h: mC.height });
            [lx, ly] = [x, y];
        };

        mC.addEventListener('mousemove', handleMove);
        mC.addEventListener('touchmove', handleMove, {passive:false});
        window.addEventListener('mouseup', () => draw = false);
        window.addEventListener('touchend', () => draw = false);

        // --- TIEMPO REAL (VER AL OTRO) ---
        // Escuchamos cuando el OTRO a√±ade un trazo nuevo
        onChildAdded(ref(db, `drawings/${partnerName}`), (snap) => {
            const d = snap.val();
            const rx = pC.width / d.w;
            const ry = pC.height / d.h;
            dLine(pCtx, d.x1*rx, d.y1*ry, d.x2*rx, d.y2*ry, d.c, d.s);
        });

        // Tambi√©n escuchamos el tuyo para que al recargar se mantenga
        onChildAdded(ref(db, `drawings/${myName}`), (snap) => {
            const d = snap.val();
            const rx = mC.width / d.w;
            const ry = mC.height / d.h;
            dLine(mCtx, d.x1*rx, d.y1*ry, d.x2*rx, d.y2*ry, d.c, d.s);
        });

        // --- L√ìGICA DE JUEGO ---
        let timer;
        onValue(ref(db, 'state'), (snap) => {
            const st = snap.val();
            if (st && st.status === 'playing') {
                document.getElementById('overlay').classList.add('hidden');
                document.getElementById('word').innerText = st.word;
                clearInterval(timer);
                timer = setInterval(() => {
                    const diff = Math.max(0, Math.round((st.endTime - Date.now()) / 1000));
                    document.getElementById('timer').innerText = `00:${diff < 10 ? '0' : ''}${diff}`;
                    if (diff <= 0) { clearInterval(timer); set(ref(db, 'state/status'), 'idle'); }
                }, 1000);
            } else {
                document.getElementById('overlay').classList.remove('hidden');
                mCtx.clearRect(0,0,mC.width,mC.height); pCtx.clearRect(0,0,pC.width,pC.height);
            }
        });

        document.getElementById('startBtn').onclick = () => {
            const w = ["PIZZA", "GATO", "PLAYA", "ANILLO", "HELADO", "UN BEB√â", "CASTILLO"];
            set(ref(db, 'state'), { status: 'playing', word: w[Math.floor(Math.random()*w.length)], endTime: Date.now() + 60000 });
            remove(ref(db, 'drawings'));
        };

        document.getElementById('reset').onclick = () => set(ref(db, 'state/status'), 'idle');
        window.clearDraw = () => remove(ref(db, `drawings/${myName}`));
    </script>
</body>
</html>
